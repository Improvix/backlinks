<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

</head>
<body class="bg-dark text-light p-4">
    <div id="loginScreen" class="text-center mt-5">
        <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Google</h3>
        <button id="loginBtn" class="btn btn-primary mt-3">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      </div>
      <div id="app" style="display: none;">    
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üìÅ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h2>
      <button id="logoutBtn" class="btn btn-outline-light btn-sm">üîí –í—ã–π—Ç–∏</button>
    </div>
</div>
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProjectModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editProjectForm">
            <input type="hidden" id="editProjectId" />
            <div class="mb-3">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" class="form-control" id="editProjectName" required />
            </div>
            <div class="mb-3">
              <label class="form-label">–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω</label>
              <input type="text" class="form-control" id="editMainDomain" required />
            </div>
            <div class="mb-3">
              <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
              <select multiple class="form-control" id="editUserSelect" required></select>
            </div>
            <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
<!-- –ü–æ–ø-–∞–ø –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProjectModalLabel">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addProjectForm">
          <div class="mb-3">
            <label for="projectName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <input type="text" class="form-control" id="projectName" required>
          </div>
          <div class="mb-3">
            <label for="mainDomain" class="form-label">–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω</label>
            <input type="text" class="form-control" id="mainDomain" required>
          </div>
          <div class="mb-3">
            <label for="userSelect" class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</label>
            <select multiple class="form-control" id="userSelect" required></select>
          </div>
          
          <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </form>
      </div>
    </div>
  </div>
</div>


    <table class="table table-dark table-bordered table-sm">
      <thead>
        <tr>
          <th>üåê –î–æ–º–µ–Ω</th>
          <th>üìå –°—Ç–∞—Ç—É—Å</th>
          <th>üîó Backlinks</th>
          <th>üì¨ Emails Sent</th>
          <th>‚úÖ URL Changed</th>
          <th>üìß Email Research</th>
          <th>‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</th>
          <th>üì§ Upload CSV</th>

        </tr>
      </thead>
      <tbody id="projectTable"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOB-rSJQ4XDJyIQu6Totoqnoz6O2CkNP8",
      authDomain: "backlinks-b4154.firebaseapp.com",
      projectId: "backlinks-b4154",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    document.getElementById('loginBtn').onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch (e) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É:', e);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å');
  }
};

    document.getElementById('logoutBtn').onclick = async () => {
  try {
    await auth.signOut();
    alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
    location.reload(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≤—Ö–æ–¥–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', e);
    alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
  }
};

auth.onAuthStateChanged(async (user) => {
  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');

  if (!user) {
    // ‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥—É
    loginScreen.style.display = 'block';
    app.style.display = 'none';
  } else {
    // ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π ‚Äî —Ö–æ–≤–∞—î–º–æ –ª–æ–≥—ñ–Ω —ñ –ø–æ–∫–∞–∑—É—î–º–æ app
    loginScreen.style.display = 'none';
    app.style.display = 'block';

    // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore –ø–æ–¥ UID (–µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç)
    const userDocRef = firebase.firestore().collection('users').doc(user.uid);
    const doc = await userDocRef.get();
    if (!doc.exists) {
      await userDocRef.set({
        email: user.email,
        type: 'user'
      });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadProjects(user.uid);
    await loadAllUsers();
  }
});



    

    const statusMap = {
  isSubdomainAndArchivarix: { text: "Subdomain +archivarix", color: "bg-purple text-white" },
  found_email: { text: "Found Email", color: "bg-primary text-white" },
  send_emails: { text: "Send Emails", color: "bg-warning text-dark" },
  check_admin: { text: "Check Admin", color: "bg-secondary text-white" },
  close: { text: "Close", color: "bg-success text-white" }
};

window.changeProjectStatus = async function (projectId, newStatus) {
  try {
    const res = await fetch(`/api/project/${projectId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_status: newStatus })
    });

    const result = await res.json();
    if (result.success) {
      const select = document.querySelector(`select[data-project-id="${projectId}"]`);
      const statusCell = select.closest('td');
      statusCell.className = "p-2"; // —Å–±—Ä–æ—Å
      statusMap[newStatus]?.color.split(" ").forEach(cls => statusCell.classList.add(cls));

      console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + result.error);
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞:', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
  }
};

    async function loadProjects(userId) {
        // USER ID ADMIN
const isAdmin = userId === 'uaLaAOAxa1SgNP3fKPbvkzG8asa2';

      const res = await fetch(`/api/user-projects?userId=${userId}`);
      const projects = await res.json();
      const table = document.getElementById('projectTable');
      table.innerHTML = '';

      for (const p of projects) {
  const tr = document.createElement('tr');

  


 const status = p.project_status || 'isSubdomainAndArchivarix';
const badge = statusMap[status] || { text: status, color: 'bg-light text-dark' };
let statusCell = `<span class="badge ${badge.color}" style="font-size: 0.8rem;">${badge.text}</span>`;

if (isAdmin) {
  statusCell = `
    <select class="form-select form-select-sm w-auto status-dropdown ${badge.color}" 
            onchange="changeProjectStatus('${p.projectId}', this.value)" 
            data-project="${p.projectId}">
      ${Object.entries(statusMap).map(([key, val]) =>
        `<option value="${key}" ${key === status ? 'selected' : ''}>${val.text}</option>`
      ).join('')}
    </select>
  `;
}


tr.innerHTML = `
  <td>${p.mainDomain}</td>
  <td>${statusCell}</td>
  <td>${p.backlinks}</td>
  <td>${p.emailsSent}</td>
  <td>${p.parsedCount}</td>
  <td>${p.emailResearch}</td>
  <td>
        <a href="${p.hasResearchLeft ? 'research.html' : 'email-builder.html'}?projectId=${p.projectId}" class="btn btn-sm btn-outline-light">‚ñ∂Ô∏è</a>
        ${isAdmin ? `
          <button class="btn btn-sm btn-outline-warning ms-1" onclick='openEditModal(${JSON.stringify(p)})'>‚úèÔ∏è</button>
        ` : ''}
      </td>
<td>
  ${isAdmin ? `
    <div style="min-width: 180px">
      <input type="file" id="file-${p.projectId}" data-project="${p.projectId}" style="display:none" accept=".csv" onchange="uploadCSV(this)">
      <button class="btn btn-sm btn-success mb-1" onclick="triggerFileInput('${p.projectId}')">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV</button>
      <div id="spinner-${p.projectId}" class="spinner-border text-success ms-2" style="width: 20px; height: 20px; display: none;" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
    </div>
  ` : ''}
</td>


`;



  table.appendChild(tr);
}

    }


document.getElementById('addProjectForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  const projectName = document.getElementById('projectName').value;
  const mainDomain = document.getElementById('mainDomain').value;
  const selected = Array.from(document.getElementById('userSelect').selectedOptions).map(opt => opt.value);
if (selected.length === 0) {
  alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
  return;
}

  if (!projectName || !mainDomain ) {
    alert('–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!');
    return;
  }

  try {
    const res = await fetch('/api/create-project', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: projectName,
        mainDomain,
        userIds: selected
      })
    });

    const result = await res.json();
    if (result.success) {
        const modalElement = document.getElementById('addProjectModal');
const modalInstance = bootstrap.Modal.getInstance(modalElement);
modalInstance.hide();
      document.getElementById('addProjectForm').reset();
      alert('–ü—Ä–æ–µ–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
      location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞: ' + (result.error || '–Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç'));
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }
});

async function loadAllUsers() {
    try {
      const res = await fetch('/api/all-users');
      const users = await res.json();

      const select = document.getElementById('userSelect');
      select.innerHTML = ''; // –æ—á–∏—â–∞–µ–º, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —É–∂–µ –±—ã–ª–∏

      users.forEach(user => {
        const opt = document.createElement('option');
        opt.value = user.uid;
        opt.textContent = user.email;
        select.appendChild(opt);
      });
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
    }
  }

  async function openEditModal(project) {
  document.getElementById('editProjectId').value = project.projectId;
  document.getElementById('editProjectName').value = project.name;
  document.getElementById('editMainDomain').value = project.mainDomain;

  const select = document.getElementById('editUserSelect');
  select.innerHTML = '';

  const res = await fetch('/api/all-users');
  const users = await res.json();

  users.forEach(user => {
    const opt = document.createElement('option');
    opt.value = user.uid;
    opt.textContent = user.email;
    if (project.userIds?.includes(user.uid)) {
      opt.selected = true;
    }
    select.appendChild(opt);
  });

  const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
  modal.show();
}

document.getElementById('editProjectForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  const id = document.getElementById('editProjectId').value;
  const name = document.getElementById('editProjectName').value;
  const mainDomain = document.getElementById('editMainDomain').value;
  const userIds = Array.from(document.getElementById('editUserSelect').selectedOptions).map(opt => opt.value);

  try {
    const res = await fetch(`/api/project/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, mainDomain, userIds })
    });

    const result = await res.json();
    if (result.success) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
      modal.hide();
      alert('–ü—Ä–æ–µ–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω!');
      location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞: ' + result.error);
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞:', e);
    alert('–ü—Ä–æ–µ–∫—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω');
  }
});



  </script>
  <script>
    window.triggerFileInput = function(projectId) {
      document.getElementById(`file-${projectId}`).click();
    };
  
    window.uploadCSV = async function(input) {
  const file = input.files[0];
  const projectId = input.dataset.project;
  const row = input.closest('tr');
  const mainDomain = row?.querySelector('td')?.textContent?.trim() || '';

  if (!file || !projectId || !mainDomain) {
    alert("–§–∞–π–ª, –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –¥–æ–º–µ–Ω –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã");
    return;
  }

  const spinner = document.getElementById(`spinner-${projectId}`);
  spinner.style.display = 'inline-block';

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async function(results) {
      const rawData = results.data;
      const total = rawData.length;
      let uploaded = 0;

      const keys = Object.keys(rawData[0] || {}).map(k => k.trim().toLowerCase());
      const urlKey = Object.keys(rawData[0] || {}).find(k => k.trim().toLowerCase() === 'referring page url');
      const langKey = Object.keys(rawData[0] || {}).find(k => k.trim().toLowerCase() === 'language');

      if (!urlKey) {
        alert("CSV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É 'Referring page URL'");
        return;
      }

      for (let i = 0; i < total; i++) {
        const row = rawData[i];
        const entry = {
          url: row[urlKey]?.trim() || '',
          lang: langKey ? (row[langKey]?.trim() || '') : '',
          email: '',
          mainDomain,
          status: 'new',
          reStatus: 'new',
          createdAt: new Date().toISOString()
        };

        if (entry.url) {
          const res = await fetch(`/api/project-backlinks/${projectId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          });

          if (res.ok) uploaded++;
        }

        // üîÅ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∏–Ω–¥–µ–∫—Å—É, –∞ –Ω–µ –ø–æ uploaded
        const percent = Math.round(((i + 1) / total) * 100);
        console.log(`üëâ ${percent}% –∑–∞–ø–æ–ª–Ω–µ–Ω–æ`);

      }

      setTimeout(() => {
      }, 800);

      alert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${uploaded} –∏–∑ ${total}`);
      location.reload();
    }
  });
};

window.changeProjectStatus = async function (projectId, newStatus) {
  try {
    const res = await fetch(`/api/project/${projectId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_status: newStatus })
    });

    const result = await res.json();

    if (result.success) {
      console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');

      // üîÑ –ù–∞—Ö–æ–¥–∏–º —Å–µ–ª–µ–∫—Ç –∏ –µ–≥–æ <td>
        const select = document.querySelector(`select[data-project="${projectId}"]`);

        if (select) {
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã —Å —Å–∞–º–æ–≥–æ select
  select.classList.remove('bg-purple', 'bg-primary', 'bg-warning', 'bg-secondary', 'bg-success', 'text-white', 'text-dark');

  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
  const colorClasses = statusMap[newStatus]?.color?.split(' ') || [];
  colorClasses.forEach(cls => select.classList.add(cls));
}

      //if (td) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã
        //td.classList.remove('bg-purple', 'bg-primary', 'bg-warning', 'bg-secondary', 'bg-success', 'text-white', 'text-dark');

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
       // const colorClasses = statusMap[newStatus]?.color?.split(' ') || [];
       // colorClasses.forEach(cls => td.classList.add(cls));
      //}

    } else {
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + result.error);
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞:', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
  }
};



  </script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .bg-purple {
      background-color: #6f42c1 !important;
      color: #fff !important;
    }
    .bg-primary {
      background-color: #0d6efd !important;
      color: #fff !important;
    }
    .bg-warning {
      background-color: #ffc107 !important;
      color: #000 !important;
    }
    .bg-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }
    .bg-success {
      background-color: #198754 !important;
      color: #fff !important;
    }
  </style>
  
  
  
</body>
</html>
