<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–µ–∫—Ç—ã –ø–æ –æ—Ç–µ–ª—è–º</title>
  <link rel="icon" href="favicon.png" type="image/x-icon" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white p-4">

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üè® Hotel projects</h2>
    <a href="index.html" class="btn btn-sm btn-outline-light">üè† Home</a>
  </div>

  <form id="createProjectForm" class="row g-3 mb-4">
    <div class="col-md-5">
      <input type="text" class="form-control" id="cityInput" placeholder="City name" required>
    </div>
    <div class="col-md-5">
      <input type="url" class="form-control" id="listingUrlInput" placeholder="URL to listing" required>
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-success">‚ûï Create project</button>
    </div>
  </form>

  <table class="table table-dark table-striped align-middle" id="projectsTable">
    <thead>
      <tr>
        <th>üèô City</th>
        <th>üîó Listing</th>
        <th>üè® Hotels</th>
        <th>üìß Sent Emails</th>
        <th>‚öôÔ∏è Action</th>
        <th>üìÖ Date</th>

      </tr>
    </thead>
    <tbody>
      <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø—Ä–æ–µ–∫—Ç—ã -->
    </tbody>
  </table>
</div>

<script>
  let projects = [];

  async function fetchProjects() {
    const res = await fetch('/api/hotels-city');
    projects = await res.json();
    renderProjects();
  }

 
  async function createProject(e) {
    e.preventDefault();
    const city = document.getElementById('cityInput').value.trim();
    const listingUrl = document.getElementById('listingUrlInput').value.trim();

    if (!city || !listingUrl) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!');

    const res = await fetch('/api/hotels-city/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ city, listingUrl })
    });

    if (res.ok) {
      document.getElementById('createProjectForm').reset();
      await fetchProjects();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
    }
  }
  async function fetchSentCount(projectId) {
  try {
    const res = await fetch(`/api/hotels-city/${projectId}/sent`);
    const data = await res.json();
    return data.length;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º:', error);
    return 0;
  }
}

async function renderProjects() {
  const tbody = document.querySelector('#projectsTable tbody'); // ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û
  tbody.innerHTML = '';

  for (const project of projects) {
    const tr = document.createElement('tr');
    const sentCount = await fetchSentCount(project.id);

    tr.innerHTML = `
      <td>${project.city}</td>
      <td><a href="${project.listingUrl}" target="_blank" class="text-info">Open listing</a></td>
      <td>${project.hotelsCount || 0}</td>
      <td>
        <a href="sent-hotels.html?projectId=${project.id}" class="btn btn-sm btn-outline-info">
          üìß ${sentCount}
        </a>
      </td>
      <td class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="parseHotels('${project.id}', this)">üîç Hotels parsing</button>
        <a href="research-hotels.html?projectId=${project.id}" class="btn btn-sm btn-outline-success">üöÄ Research</a>
      </td>
            <td>${new Date(project.createdAt).toLocaleDateString()}</td>

    `;

    tbody.appendChild(tr); // ‚Üê —Å—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É!
  }
}



  async function parseHotels(projectId, button) {
    if (!confirm('–¢–æ—á–Ω–æ —Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–µ–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞?')) return;

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ü–∞—Ä—Å–∏–Ω–≥...';

    const res = await fetch(`/api/hotels-city/${projectId}/parse`, { method: 'POST' });

    if (res.ok) {
      alert('–û—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω—ã!');
      await fetchProjects();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –æ—Ç–µ–ª–µ–π');
    }

    button.disabled = false;
    button.innerHTML = 'üîç –°–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–µ–ª–∏';
  }

  document.getElementById('createProjectForm').addEventListener('submit', createProject);

  fetchProjects();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>