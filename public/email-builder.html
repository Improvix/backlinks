<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Email Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png" type="image/x-icon" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script src="/firebase-init.js"></script>



  <style>
    body {
      padding: 2rem;
      background-color: #121212;
    }
    .form-label {
      margin-top: 0.5rem;
    }
    .preview-box {
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 1rem;
      min-height: 400px;
    }
    .btn {
      margin-right: 0.5rem;
    }
    input[readonly] {
  cursor: pointer;
}

  </style>
</head>
<body>
    
  <div class="container-fluid">
    <nav class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <a href="index.html" class="btn btn-sm btn-outline-light me-2">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      </div>
      <div>
        <span class="text-secondary small">–ü—Ä–æ–µ–∫—Ç ID: <span id="projectIdDisplay">‚Äî</span></span>
      </div>
    </nav>
    
    <div class="row g-4">
      <h3 class="text-light mb-0">Email Builder</h3>

      <div class="col-md-4">
         <!-- <div class="mb-3">
          <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV –≤ Firebase</label>
          <div class="row g-2">
            <div class="col">
              <input type="file" class="form-control" id="csvUpload" accept=".csv">
            </div>
            <div class="col-auto">
              <button class="btn btn-primary" onclick="uploadCSVToFirebase()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
          </div>
        </div>
      -->
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
          <span id="newCount" class="btn btn-outline-light btn-sm disabled">
            üì® Emails Left: ...
          </span>
          <a id="sentLink" class="btn btn-sm btn-success">
            ‚úÖ Sent: 0
          </a>
          <a id="invalidLink" class="btn btn-sm btn-warning">
            ‚ùó Invalid: 0
          </a>
          
        </div>
        

       
        


      <div class="p-3 mb-4 rounded border" style="background-color: #1b1b1b; border-color: #333;">
        <h5 class="text-light mb-3">üìå –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è</h5>
      
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label">üåê Backlink Language</label>
            <input id="language" class="form-control" maxlength="2" oninput="onBacklinkLangChange()" />
            <div class="invalid-feedback">
              –í–≤–µ–¥–∏—Ç–µ 2 –±—É–∫–≤—ã —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: <strong>en</strong> –∏–ª–∏ <strong>de</strong>
            </div>
            
          </div>
          <div class="col-6">
            <label for="lang" class="form-label">‚úâÔ∏è Email Template</label>
            <select id="lang" class="form-select">
            </select>
          </div>
        </div>
        <a id="createTemplateBtn" class="btn btn-sm btn-outline-light me-2">‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</a>

        <div class="mb-3">
          <label class="form-label">üìù Subject</label>
          <input id="subject" class="form-control" readonly onclick="copySubject()" />
        </div>
      
        <div class="mb-0">
          <label class="form-label">üìß Email</label>
          <input id="email" class="form-control" readonly onclick="copyEmail()" />
        </div>
      </div>
      <div class="mb-4">
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <button class="btn btn-secondary btn-sm" onclick="loadPrev()">‚Üê</button>
          <button class="btn btn-secondary btn-sm" onclick="loadNext()">Next ‚Üí</button>
          <button class="btn btn-outline-success btn-sm" onclick="markAsSent()">‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
          <button class="btn btn-outline-warning btn-sm" onclick="markAsInvalid()">√ó –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π</button>
        </div>
      </div>
        
      <div class="accordion mb-3" id="advancedFields">
        <div class="accordion-item bg-dark border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFields" aria-expanded="false" aria-controls="collapseFields">
              ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            </button>
          </h2>
          <div id="collapseFields" class="accordion-collapse collapse" data-bs-parent="#advancedFields">
            <div class="accordion-body">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input id="name" class="form-control" placeholder="e.g. Handelszeitung.ch" />
              </div>
              <div class="mb-3">
                <label for="old_link" class="form-label">Old URL</label>
                <input id="old_link" class="form-control" placeholder="e.g. http://old.com" />
              </div>
              <div class="mb-3">
                <label for="new_link" class="form-label">New URL</label>
                <input id="new_link" class="form-control" placeholder="e.g. https://new.com" />
              </div>
              <div class="mb-3">
                <label for="articles" class="form-label">Article URLs</label>
                <textarea id="articles" class="form-control" rows="4" placeholder="One URL per line"></textarea>
              </div>
              <button class="btn btn-outline-light btn-sm" onclick="updatePreview()">üîÑ Preview</button>

            </div>
          </div>
        </div>
      </div>

       
        
      </div>
      <div class="col-md-8">
        <div class="d-flex align-items-center mb-3">
          <h3 class="text-light mb-0">Preview</h3>
          <button
            class="btn btn-sm btn-outline-light ms-3 p-2"
            onclick="copyPreviewAsText()"
            title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–≤—å—é"
            style="line-height: 1; display: flex; align-items: center;"
          >
            üíæ Copy
          </button>
        </div>
        
        
        <div class="preview-box text-white" id="output"></div>
      </div>
    </div>
  </div>

  <script>
    let template = '';

    async function fetchTemplate() {
  const lang = document.getElementById('lang').value;
  const projectId = new URLSearchParams(window.location.search).get('projectId');

  if (!lang || !projectId) {
    console.error('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏–ª–∏ projectId');
    return;
  }

  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞
    const res = await fetch(`/api/project-templates/${projectId}`);
    const templates = await res.json();

    // –ò—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
    const selectedTemplate = templates.find(t => t.id === lang);

    if (!selectedTemplate) {
      document.getElementById('output').innerHTML = '<p>–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
      window.template = '';
      return;
    }

    // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º HTML —à–∞–±–ª–æ–Ω
    window.template = selectedTemplate.html;

    // === –í–û–¢ –≠–¢–û –î–û–ë–ê–í–õ–Ø–ï–ú: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Subject ===
    const subjectField = document.getElementById('subject');
    if (subjectField && selectedTemplate.subject) {
      subjectField.value = selectedTemplate.subject;
    } else if (subjectField) {
      subjectField.value = '';
    }
    // ==============================================

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
    updatePreview();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞:', error);
    document.getElementById('output').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞</p>';
  }
}





function updatePreview() {
  if (!window.template) {
    console.warn('–®–∞–±–ª–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    document.getElementById('output').innerHTML = '<p>–®–∞–±–ª–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>';
    return;
  }

  const values = {
    name: document.getElementById('name')?.value || '',
    old_link: document.getElementById('old_link')?.value || '',
    new_link: document.getElementById('new_link')?.value || '',
    articles: (document.getElementById('articles')?.value || '')
      .split('\n')
      .filter(x => x.trim())
      .map(link => `<li><a href="${link}">${link}</a></li>`)
      .join('')
  };

  let result = window.template;
  for (const key in values) {
    const regex = new RegExp(`%${key}%`, 'g');
    result = result.replace(regex, values[key]);
  }

  document.getElementById('output').innerHTML = result;
}


    async function downloadHTML() {
      const lang = document.getElementById('lang').value;
      const values = {
        name: document.getElementById('name').value,
        old_link: document.getElementById('old_link').value,
        new_link: document.getElementById('new_link').value,
        articles: document.getElementById('articles').value
          .split('\n')
          .filter(x => x.trim())
          .map(link => `<li><a href="${link}">${link}</a></li>`)
          .join('')
      };

      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lang, values })
      });

      const html = await res.text();
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'email.html';
      a.click();
    }

    function copyToClipboard() {
      const html = document.getElementById('output').innerHTML;
      const el = document.createElement('textarea');
      el.value = html;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      alert("Email HTML copied to clipboard!");
    }

    function onBacklinkLangChange() {
  const input = document.getElementById('language');
  if (input.readOnly) return;

  let val = input.value.trim().toLowerCase();

  // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–µ–≥–æ
  if (val.length > 2) {
    val = val.slice(0, 2);
    input.value = val;
  }

  const sendBtn = document.querySelector('[onclick="markAsSent()"]');

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏–º —è–∑—ã–∫ –ø–∏—Å—å–º–∞
  autoSetEmailLanguage();

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
  if (!val || val.length !== 2) {
    sendBtn.disabled = true;
    input.classList.add('is-invalid');
  } else {
    sendBtn.disabled = false;
    input.classList.remove('is-invalid');
  }
}



async function updateCounters() {
  const projectId = new URLSearchParams(window.location.search).get('projectId');
  if (!projectId) return;

  // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
  const sentRes = await fetch(`/api/project-backlinks/sent-count?projectId=${projectId}`);
  const sentData = await sentRes.json();
  const sentCount = sentData.count || 0;
  document.getElementById('sentLink').textContent = `üì¨ Send: ${sentCount}`;

  // –ù–æ–≤—ã–µ
  const newRes = await fetch(`/api/project-backlinks/to-send-count?projectId=${projectId}`);
  const newData = await newRes.json();
  const newCount = newData.count || 0;
  document.getElementById('newCount').textContent = `üì® Emails Left: ${newCount}`;

  // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ
  const invalidRes = await fetch(`/api/project-backlinks/invalid-count?projectId=${projectId}`);
  const invalidData = await invalidRes.json();
  const invalidCount = invalidData.count || 0;
  document.getElementById('invalidLink').textContent = `‚ö†Ô∏è Invalid: ${invalidCount}`;
}

async function loadTemplates() {
  const projectId = new URLSearchParams(window.location.search).get('projectId');
  if (!projectId) return;

  const res = await fetch(`/api/project-templates/${projectId}`);
  const templates = await res.json();

  const langSelect = document.getElementById('lang');
  langSelect.innerHTML = ''; // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ

  // –ï—Å–ª–∏ –µ—Å—Ç—å —à–∞–±–ª–æ–Ω—ã
  if (templates.length > 0) {
    templates.forEach(template => {
      const option = document.createElement('option');
      option.value = template.id;
      option.textContent = template.name;
      langSelect.appendChild(option);
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω
    langSelect.value = templates[0].id;
    await fetchTemplate();
  } else {
    // –ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ ‚Äî –≤—Å—ë –æ—á–∏—â–∞–µ–º
    window.template = '';
    document.getElementById('output').innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</p>';
    const subjectField = document.getElementById('subject');
    if (subjectField) subjectField.value = '';
  }
}



window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const article = params.get('article');
  const domain = params.get('domain');
  const projectId = params.get('projectId');

  if (projectId) {
    document.getElementById('sentLink').href = `sent.html?projectId=${projectId}`;
    document.getElementById('invalidLink').href = `invalid.html?projectId=${projectId}`;
    document.getElementById('projectIdDisplay').textContent = projectId;
  }

  if (article) document.getElementById('articles').value = article;
  if (domain) document.getElementById('name').value = domain;

  document.getElementById('old_link').value = 'ellington-hotel.com';
  document.getElementById('new_link').value = 'https://ellington-hotel.com-en.com/';

  // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
  loadTemplates().then(() => {
    fetchTemplate(); // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ ‚Äî –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø—Ä–µ–≤—å—é
    updateSubject(); // –ò –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É –ø–∏—Å—å–º–∞
  });

  loadFromFirebase();
  updateCounters();
};


document.getElementById('lang').addEventListener('change', () => {
  fetchTemplate();
  updateSubject();
});

function updateSubject() {
  const lang = document.getElementById('lang').value;
  const subjectField = document.getElementById('subject');

  if (lang === 'english') {
    subjectField.value = "Action Required: Update Link to Ellington Hotel";
  } else if (lang === 'german') {
    subjectField.value = "Dringende Anfrage: Link zu unserer Hotel-Website aktualisieren";
  } else {
    subjectField.value = '';
  }
}

function showToast(message = "Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!") {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, 2000); // —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
}

  </script>

 
  <script>
    let emailData = [];

    async function loadFromFirebase() {
      const projectId = new URLSearchParams(window.location.search).get('projectId');
const res = await fetch(`/api/project-backlinks-ready?projectId=${projectId}`);
      emailData = await res.json();
      currentIndex = 0;
      loadNext();
    }

    async function markAsSent() {
      if (currentIndex === 0 || currentIndex > emailData.length) {
        alert("–ù–µ—á–µ–≥–æ –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ");
        return;
      }

      const prevIndex = currentIndex - 1;
      const entry = emailData[prevIndex];

      const emailLang = document.getElementById('lang').value;
      const backlinkLang = document.getElementById('language').value.trim().toLowerCase();


      const projectId = new URLSearchParams(window.location.search).get('projectId');
await fetch(`/api/project-backlinks/${projectId}/${entry.id}/send`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    sentAt: new Date().toISOString(),
    emailLang,
    lang: backlinkLang
  })
});


      emailData.splice(currentIndex - 1, 1);
// –ù–ï –º–µ–Ω—è–µ–º currentIndex ‚Äî –æ–Ω —É–∂–µ —Å–¥–≤–∏–Ω—É—Ç –≤–ø–µ—Ä—ë–¥ –≤ loadNext
currentIndex--; // üëà —Ç–æ–ª—å–∫–æ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∑–∞–¥, –ø–æ—Ç–æ–º—É —á—Ç–æ loadNext –ø–æ—Ç–æ–º —Å–Ω–æ–≤–∞ —É–≤–µ–ª–∏—á–∏—Ç

      if (emailData.length === 0) {
        alert("–í—Å–µ –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!");
        document.getElementById('articles').value = '';
        document.getElementById('name').value = '';
        document.getElementById('language').value = '';
        document.getElementById('email').value = '';
        document.getElementById('output').innerHTML = '';
        return;
      }

      loadNext();
      updateCounters();

    }

    async function markAsInvalid() {
  if (currentIndex === 0 || currentIndex > emailData.length) {
    alert("–ù–µ—á–µ–≥–æ –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ");
    return;
  }

  const prevIndex = currentIndex - 1;
  const entry = emailData[prevIndex];

  const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ—á–µ–º—É —Å—Å—ã–ª–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞:");
  if (!reason) return;

  const projectId = new URLSearchParams(window.location.search).get('projectId');
await fetch(`/api/project-backlinks/${projectId}/${entry.id}/invalidate`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ reason })
});


  emailData.splice(prevIndex, 1);
  currentIndex = prevIndex;

  if (emailData.length === 0) {
    alert("–ë–æ–ª—å—à–µ –Ω–µ—Ç –ø–∏—Å–µ–º!");
    document.getElementById('articles').value = '';
    document.getElementById('name').value = '';
    document.getElementById('language').value = '';
    document.getElementById('email').value = '';
    document.getElementById('output').innerHTML = '';
    return;
  }

  loadNext();
  updateCounters();

}



    let currentIndex = 0;
    
       
    function extractDomain(url) {
      try {
        const u = new URL(url);
        return u.hostname;
      } catch (e) {
        return '';
      }
    }

    function autoSetEmailLanguage() {
  const backlinkLang = document.getElementById('language').value.trim().toLowerCase();
  const emailLangSelect = document.getElementById('lang');

  if (backlinkLang === 'de') {
    emailLangSelect.value = 'german';
  } else if (backlinkLang === 'en') {
    emailLangSelect.value = 'english';
  } else {
    emailLangSelect.value = 'english';
  }

  // –û–±–Ω–æ–≤–∏–º —à–∞–±–ª–æ–Ω –∏ subject –ø—Ä–∏ –∞–≤—Ç–æ—Å–º–µ–Ω–µ
  fetchTemplate();
  updateSubject();
}

    
    function loadNext() {
      if (currentIndex >= emailData.length) {
        alert("–ë–æ–ª—å—à–µ –Ω–µ—Ç –ø–∏—Å–µ–º!");
        return;
      }
    
      const { url, lang, email } = emailData[currentIndex++];
      document.getElementById('articles').value = url ? url + '\n' : '';
      document.getElementById('name').value = extractDomain(url);
      document.getElementById('language').value = lang;
      document.getElementById('language').readOnly = !!lang; // –±–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ lang —É–∂–µ –µ—Å—Ç—å

      autoSetEmailLanguage();
      onBacklinkLangChange(); // üëà –î–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
      document.getElementById('email').value = email;
    
      updatePreview();
    }
    function loadPrev() {
  if (currentIndex <= 1) {
    alert("–≠—Ç–æ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ!");
    return;
  }
  currentIndex -= 2; // —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
  loadNext();        // –ø–æ—Ç–æ–º—É —á—Ç–æ loadNext —É–≤–µ–ª–∏—á–∏—Ç —Å–Ω–æ–≤–∞
}

    
    function copyEmail() {
      const email = document.getElementById('email');
      email.select();
      email.setSelectionRange(0, 99999);
      document.execCommand('copy');
      showToast("Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    }
    function copySubject() {
  const subject = document.getElementById('subject');
  subject.select();
  subject.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  document.execCommand('copy');
  showToast("Subject —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
}


    function copyPreviewAsText() {
  const range = document.createRange();
  const output = document.getElementById('output');
  range.selectNode(output);

  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);

  try {
    const success = document.execCommand('copy');
    if (success) {
      showToast("–ü—Ä–µ–≤—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
    } else {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
    }
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: " + err);
  }

  selection.removeAllRanges();
}
    </script>
      <script>
        async function uploadCSVToFirebase() {
          const fileInput = document.getElementById('csvUpload');
          const file = fileInput.files[0];
          if (!file) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª");
            return;
          }
      
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async function(results) {
              const rawData = results.data;
      
              const sampleRow = rawData[0] || {};
              const keys = Object.keys(sampleRow);
      
              const urlKey = keys.find(k => k.toLowerCase().includes('referr'));
              const langKey = keys.find(k => k.toLowerCase().includes('lang'));
              const emailKey = keys.find(k => k.toLowerCase().includes('email'));
      
              if (!urlKey || !emailKey) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è (URL –∏–ª–∏ Email). –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ CSV.");
                return;
              }
      
              let successCount = 0;
              const mainDomainKey = keys.find(k => k.toLowerCase().includes('maindomain'));

if (!mainDomainKey) {
  alert("–í CSV –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ mainDomain");
  return;
}

for (const row of rawData) {
  const entry = {
    url: row[urlKey]?.trim() || '',
    lang: row[langKey]?.trim() || '',
    email: row[emailKey]?.trim() || '',
    mainDomain: row[mainDomainKey]?.trim() || '',
    status: 'new'
  };

      
                if (entry.url && entry.email) {
                  await fetch('/api/backlinks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                  });
                  successCount++;
                }
              }
      
              alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ Firebase: ${successCount} –∑–∞–ø–∏—Å–µ–π`);
              loadFromFirebase(); // –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫
            }
          });
        }

        document.getElementById('createTemplateBtn').addEventListener('click', () => {
  const projectId = new URLSearchParams(window.location.search).get('projectId');
  if (!projectId) {
    alert('Project ID –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    return;
  }
  window.location.href = `/builder/builder.html?projectId=${projectId}`;
});

      </script>
      <div id="toast" style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      font-weight: bold;
    ">
      Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
