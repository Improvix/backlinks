<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Builder Hotels</title>
  <link rel="icon" href="favicon.png" type="image/x-icon" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { overflow-x: hidden; }
    .preview-container { min-height: 400px; background: #222; padding: 20px; border-radius: 10px; overflow-y: auto; }
    .sidebar { background: #333; padding: 20px; border-radius: 10px; }
    textarea { min-height: 150px; }
  </style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="/firebase-init.js"></script>

</head>
<body class="bg-dark text-white p-4">

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="hotelTitle">üè® Email Builder</h2>
      </div>
  <div class="row">

    <!-- Sidebar -->
    <div class="col-md-3 sidebar">
      <h4 class="mb-4">Email settings</h4>

      <button id="sentCounter" class="btn btn-outline-info mb-3" onclick="openSentPage()">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 0</button>

      <div class="mb-3">
        <label>Email:</label>
        <input type="text" id="emailDisplay" class="form-control mb-2" readonly onclick="copyField('emailDisplay')">
      </div>

      <div class="mb-3">
        <label>Badge URL:</label>
        <input type="text" id="hotelLinkDisplay" class="form-control mb-2" readonly>
      </div>

      <div class="mb-3">
        <label>ID Hotel:</label>
        <input type="text" id="hotelIdDisplay" class="form-control mb-2" readonly>
      </div>

      <div class="mb-3">
        <label>Subject:</label>
        <input type="text" id="subjectDisplay" class="form-control mb-2" readonly onclick="copyField('subjectDisplay')">
      </div>

      <div class="mb-3">
        <label>Email Template:</label>
        <select id="templateSelect" class="form-select" onchange="applyTemplate()"></select>
      </div>

      <button class="btn btn-outline-light w-100 mb-3" onclick="createTemplate()">‚ûï Create template</button>

      <div class="d-grid gap-2">
        <button class="btn btn-secondary" onclick="prevHotel()">‚¨ÖÔ∏è Back</button>
        <button class="btn btn-secondary" onclick="nextHotel()">‚û°Ô∏è Next</button>
        <button class="btn btn-success" onclick="markSent()">üì© Send</button>
        <button class="btn btn-danger" onclick="markInvalid()">‚ùå Invalid</button>
        <div id="remainingCounter" class="mt-3 text-light"></div>

      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 id="previewTitle" class="mb-0">–ü—Ä–µ–≤—å—é –ø–∏—Å—å–º–∞ –¥–ª—è ...</h5>
          <button
            class="btn btn-sm btn-outline-light ms-3 p-2"
            onclick="copyPreviewAsText()"
            title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–≤—å—é"
            style="line-height: 1; display: flex; align-items: center;"
          >
            üíæ Copy
          </button>
        </div>
      
        <div id="previewContainer" class="preview-container"></div>
      </div>
      
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const projectId = urlParams.get('projectId');

let hotels = [];
let currentHotelIndex = 0;
let listingUrl = '';
let templates = [];
let currentHtml = '';

async function fetchProjectAndHotels() {
  const projectRes = await fetch(`/api/hotels-city/${projectId}`);
  const project = await projectRes.json();
  
  listingUrl = project.listingUrl.split('?')[0];
  city = project.city; // <<< —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥

  const hotelsRes = await fetch(`/api/hotels-city/${projectId}/hotels`);
  hotels = await hotelsRes.json();
  hotels = hotels.filter(hotel => hotel.status === 'done');

  if (hotels.length === 0) {
    alert('‚úÖ –í—Å–µ –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
    return;
  }

  showHotel();

  try {
    const templatesRes = await fetch(`/api/hotels-city/${projectId}/templates`);
    templates = await templatesRes.json();
    fillTemplates();
  } catch (error) {
    console.warn('–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ ‚Äî –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π');
  }
}



function fillTemplates() {
  const select = document.getElementById('templateSelect');
  select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</option>';
  templates.forEach((t, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = t.name;
    select.appendChild(option);
  });

  // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
  const savedTemplateIdx = localStorage.getItem(`selectedTemplate_${projectId}`);
  if (savedTemplateIdx !== null && templates[savedTemplateIdx]) {
    select.value = savedTemplateIdx;
    applyTemplate();
  } else if (templates.length > 0) {
    select.value = 0;
    applyTemplate();
  }
}

function showHotel() {
  const hotel = hotels[currentHotelIndex];
  const fullHotelLink = `${listingUrl}?recommended_hotel_id=${hotel.hotelId}`;

  document.getElementById('hotelTitle').textContent = `üè® ${hotel.name}`;
  document.getElementById('previewTitle').textContent = `–ü—Ä–µ–≤—å—é –ø–∏—Å—å–º–∞ –¥–ª—è "${hotel.name}"`;

  document.getElementById('emailDisplay').value = hotel.email;
  document.getElementById('hotelLinkDisplay').value = fullHotelLink;
  document.getElementById('hotelIdDisplay').value = hotel.hotelId;

  updatePreview();
}

function applyTemplate() {
  const idx = document.getElementById('templateSelect').value;
  if (idx === '') return;

  const tpl = templates[idx];
  document.getElementById('subjectDisplay').value = tpl.subject;
  currentHtml = tpl.html;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –≤ localStorage
  localStorage.setItem(`selectedTemplate_${projectId}`, idx);

  updatePreview();
}

function updatePreview() {
  const hotel = hotels[currentHotelIndex];

  if (!currentHtml) return;

  const badgeUrl = document.getElementById('hotelLinkDisplay').value; // –ø–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å ID

  // cleanUrl = base —Å—Å—ã–ª–∫–∞ –±–µ–∑ id –æ—Ç–µ–ª—è
  const cleanUrl = badgeUrl.split('-')[0];

  const replaced = currentHtml
    .replace(/%name%/g, hotel.name)
    .replace(/%city%/g, city)
    .replace(/%hotelid%/g, hotel.hotelId)
    .replaceAll('%listingurl%', badgeUrl) // –í href –≤—Å—Ç–∞–≤–ª—è–µ–º –ü–û–õ–ù–£–Æ —Å—Å—ã–ª–∫—É
    .replaceAll('%cleanurl%', cleanUrl); // –í —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –ö–†–ê–°–ò–í–£–Æ —Å—Å—ã–ª–∫—É

  document.getElementById('previewContainer').innerHTML = replaced;
}




function copyField(id) {
  const field = document.getElementById(id);
  navigator.clipboard.writeText(field.value);
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–≤—å—é
function copyPreviewAsText() {
  const range = document.createRange();
  const output = document.getElementById('previewContainer'); // <<< –û–ë–†–ê–¢–ò –í–ù–ò–ú–ê–ù–ò–ï!
  range.selectNode(output);

  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);

  try {
    const success = document.execCommand('copy');
    if (success) {
      showToast("–ü—Ä–µ–≤—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
    } else {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.");
    }
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: " + err);
  }

  selection.removeAllRanges();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç–æ—Å—Ç–∞
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = '#333';
  toast.style.color = 'white';
  toast.style.padding = '10px 20px';
  toast.style.borderRadius = '8px';
  toast.style.zIndex = '9999';
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 2000);
}


function createTemplate() {
  const hotel = hotels[currentHotelIndex];
  window.location.href = `/builder/builder-hotels.html?projectId=${projectId}&hotelId=${hotel.hotelId}`;
}

async function markSent() {
  const hotel = hotels[currentHotelIndex];
  await fetch(`/api/hotels-city/${projectId}/hotels/${hotel.hotelId}/send`, { method: 'POST' });
  nextHotel();
}

async function markInvalid() {
  const hotel = hotels[currentHotelIndex];
  await fetch(`/api/hotels-city/${projectId}/hotels/${hotel.hotelId}/mark-invalid`, { method: 'POST' });
  nextHotel();
}

function prevHotel() {
  if (currentHotelIndex > 0) {
    currentHotelIndex--;
    showHotel();
  }
}

function nextHotel() {
  if (currentHotelIndex < hotels.length - 1) {
    currentHotelIndex++;
    showHotel();
  } else {
    alert('‚úÖ –í—Å–µ –ø–∏—Å—å–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!');
  }
}

fetchProjectAndHotels();

async function updateSentCounter() {
  const res = await fetch(`/api/hotels-city/${projectId}/sent`);
  const sentHotels = await res.json();
  document.getElementById('sentCounter').textContent = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sentHotels.length}`;
}

function openSentPage() {
  window.location.href = `/sent-hotels.html?projectId=${projectId}`;
}

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
updateSentCounter();

async function updateRemainingCounter() {
  try {
    const res = await fetch(`/api/hotels-city/${projectId}/remaining`);
    const remaining = await res.json();
    document.getElementById('remainingCounter').innerHTML = `–û—Å—Ç–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: <strong>${remaining.length}</strong> –ø–∏—Å–µ–º`;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∏—Å–µ–º:', error);
  }
}

updateRemainingCounter();


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>